

#region using statements

using DataJuggler.Blazor.Components;
using DataJuggler.Blazor.Components.Interfaces;
using DataJuggler.PixelDatabase;
using DataJuggler.UltimateHelper;
using DataJuggler.UltimateHelper.Objects;
using Microsoft.AspNetCore.Components;
using System.Drawing;
using System.Drawing.Text;
using System.Runtime.Versioning;

#endregion

namespace NotJeopardy.Components.Pages
{

    #region class Home
    /// <summary>
    /// This class is the main page for this app
    /// </summary>
    
    [SupportedOSPlatform("windows")]
    public partial class Home : IBlazorComponentParent
    {
        
        #region Private Variables
        private ImageComponent blueImage;
        private ImageButton createImageButton;
        private TextBoxComponent promptTextBox;
        private LinkButton downloadButton;
        #endregion
        
        #region Events
            
        #endregion
        
        #region Methods
            
            #region ButtonClicked(int buttonNumber, string buttonText)
            /// <summary>
            /// method handles a button click
            /// </summary>
            public void ButtonClicked(int buttonNumber, string buttonText)
            {
                // get the fullPath of the image
                string path = Path.Combine(Environment.CurrentDirectory, @"wwwroot\Images\Blue.png");

                // If the path Exists On Disk
                if ((FileHelper.Exists(path)) && (HasPromptTextBox) && (HasBlueImage))
                {
                    // Load the PixelDatabase
                    PixelDatabase pixelDatabase = PixelDatabaseLoader.LoadPixelDatabase(path, null);

                    // If the pixelDatabase object exists
                    if (NullHelper.Exists(pixelDatabase))
                    {
                        // Create a font
                        Font font = GetITCFont(64);

                        // If the font object exists
                        if (font != null)
                        {
                            // Get the text
                            string text = PromptTextBox.Text;

                            // create a delimiter
                            char[] delimiter = new char[] { ' ' };

                            // Get the words
                            List<Word> words = TextHelper.GetWords(text, delimiter);

                            // Convert the words into lines
                            List<TextLine> lines = ConvertWordsToLines(words);

                            // if there are one or more lines
                            if (ListHelper.HasOneOrMoreItems(lines))
                            {
                                // iterate the lines
                                for (int x = 0; x < lines.Count; x++)
                                {
                                    // Get the lineTop
                                    int lineTop = GetLineTop(x, lines.Count);

                                    // Draw the text
                                    pixelDatabase.DrawText(lines[x].Text, font, new Point(960, lineTop), StringAlignment.Center, StringAlignment.Center, Brushes.White);
                                }
                            }

                            // Create file name with a partial guid for uniqueness
                            string savedFilename = FileHelper.CreateFileNameWithPartialGuid(path, 12);

                            // Save the file
                            pixelDatabase.SaveAs(savedFilename);

                            // Get the name of the file
                            FileInfo fileInfo = new FileInfo(savedFilename);

                            // set the imageUrl
                            string imageUrl = "../Images/" + fileInfo.Name;

                            // Set the BlueImage
                            BlueImage.SetImageUrl(imageUrl);

                            // Show the component
                            BlueImage.SetVisible(true);
                        }
                    }
                }
            }
            #endregion
            
            #region ConvertWordsToLines(List<Word> words)
            /// <summary>
            /// returns a list of Words To Lines
            /// </summary>
            public List<TextLine> ConvertWordsToLines(List<Word> words)
            {
                // initial value
                List<TextLine> lines = new List<TextLine>();

                // characters per line is just a guess at this point
                int charactersPerLine = 24;

                // locals
                int currentLineCharacters = 0;
                TextLine currentLine = new TextLine();
                currentLine.Words = new List<Word>();
                lines.Add(currentLine);

                // If the words collection exists and has one or more items
                if (ListHelper.HasOneOrMoreItems(words))
                {
                    // Iterate the collection of Word objects
                    foreach (Word word in words)
                    {
                        // if this word will fit in this line
                        if ((word.Text.Length + currentLineCharacters) <= charactersPerLine)
                        {
                            // if this is the first word forf this line
                            if (currentLine.Words.Count == 0)
                            {
                                // add to this line
                                currentLine.Text = word.Text.ToUpper();

                                // Set the currentLineCharacters value
                                currentLineCharacters += word.Text.Length;                                
                            }
                            else
                            {
                                // add to this line
                                currentLine.Text += " " + word.Text.ToUpper();

                                // Set the currentLineCharacters value
                                currentLineCharacters += word.Text.Length + 1;
                            }

                            // Add this word
                            currentLine.Words.Add(word);
                        }
                        else
                        {
                            // start a new line
                            currentLine = new TextLine();

                            // Create the Words
                            currentLine.Words = new List<Word>();

                            // Set the text
                            currentLine.Text = word.Text.ToUpper();

                            // Set the currentLineCharacters value
                            currentLineCharacters = word.Text.Length;         

                            // Add this line
                            lines.Add(currentLine);

                            // Add this word
                            currentLine.Words.Add(word);
                        }
                    }
                }

                // return value
                return lines;
            }
            #endregion
            
            #region GetITCFont(float size, FontStyle style = FontStyle.Regular)
            /// <summary>
            /// method returns the ITC Font
            /// </summary>
            public Font GetITCFont(float size, FontStyle style = FontStyle.Regular)
            {
                InstalledFontCollection fonts = new InstalledFontCollection();
                Font result = null;

                foreach (FontFamily family in fonts.Families)
                {
                    if (family.Name.StartsWith("ITC", StringComparison.OrdinalIgnoreCase))
                    {
                        Console.WriteLine($"Found ITC font: {family.Name}");
                        result = new Font(family, size, style);
                        break;
                    }
                }

                // If nothing was found, use a default
                if (result == null)
                {
                    Console.WriteLine("No ITC fonts found. Using default font.");
                    result = new Font(FontFamily.GenericSansSerif, size, style);
                }

                return result;
            }
            #endregion
            
            #region GetLineTop(int currentLine, int totalLines)
            /// <summary>
            /// Returns the Y coordinate (top) for a given line so that all lines are centered vertically.
            /// </summary>
            public int GetLineTop(int currentLine, int totalLines)
            {
                const int imageHeight = 1080;
                const int mid = imageHeight / 2;

                // You can tweak this for your font size / spacing
                const int lineSpacing = 128;

                // Compute total height of the text block
                int blockHeight = (totalLines - 1) * lineSpacing;

                // Top of the first line so the block is centered
                int startY = mid - blockHeight / 2;

                // Current line top
                int top = startY + (currentLine * lineSpacing);

                // return the top
                return top;
            }
            #endregion
            
            #region ReceiveData(Message message)
            /// <summary>
            /// This method is used to receive messages from other components or pages
            /// </summary>
            public void ReceiveData(Message message)
            {

            }
            #endregion
            
            #region Refresh()
            /// <summary>
            /// This method is used to update the UI after changes
            /// </summary>
            public void Refresh()
            {
                InvokeAsync(() =>
                {
                    // Refresh
                    StateHasChanged();
                });
            }
            #endregion
            
            #region Register(IBlazorComponent component)
            /// <summary>
            /// This method is used to store child controls that are on this component or page
            /// </summary>
            public void Register(IBlazorComponent component)            
            {
                if (component is ImageButton tempImageButton)
                {
                    // store the ImageButton component
                    if (component.Name == "CreateImageButton")
                    {
                        CreateImageButton = tempImageButton;
                    }
                }
            }
            #endregion

        #endregion

        #region Properties

            #region BlueImage               
            /// This property gets or sets the value for 'BlueImage'.
            /// </summary>
            public ImageComponent BlueImage
            {
                get { return blueImage; }
                set { blueImage = value; }
            }
            #endregion
            
            #region CreateImageButton
            /// <summary>
            /// This property gets or sets the value for 'CreateImageButton'.
            /// </summary>
            public ImageButton CreateImageButton
            {
                get { return createImageButton; }
                set { createImageButton = value; }
            }
            #endregion
            
            #region DownloadButton
            /// <summary>
            /// This property gets or sets the value for 'DownloadButton'.
            /// </summary>
            public LinkButton DownloadButton
            {
                get { return downloadButton; }
                set { downloadButton = value; }
            }
            #endregion
            
            #region HasBlueImage
            /// <summary>
            /// This property returns true if this object has a 'BlueImage'.
            /// </summary>
            public bool HasBlueImage
            {
                get
                {
                    // initial value
                    bool hasBlueImage = (BlueImage != null);

                    // return value
                    return hasBlueImage;
                }
            }
            #endregion
            
            #region HasCreateImageButton
            /// <summary>
            /// This property returns true if this object has a 'CreateImageButton'.
            /// </summary>
            public bool HasCreateImageButton
            {
                get
                {
                    // initial value
                    bool hasCreateImageButton = (CreateImageButton != null);

                    // return value
                    return hasCreateImageButton;
                }
            }
            #endregion
            
            #region HasDownloadButton
            /// <summary>
            /// This property returns true if this object has a 'DownloadButton'.
            /// </summary>
            public bool HasDownloadButton
            {
                get
                {
                    // initial value
                    bool hasDownloadButton = (DownloadButton != null);

                    // return value
                    return hasDownloadButton;
                }
            }
            #endregion
            
            #region HasPromptTextBox
            /// <summary>
            /// This property returns true if this object has a 'PromptTextBox'.
            /// </summary>
            public bool HasPromptTextBox
            {
                get
                {
                    // initial value
                    bool hasPromptTextBox = (PromptTextBox != null);

                    // return value
                    return hasPromptTextBox;
                }
            }
            #endregion
            
            #region PromptTextBox
            /// <summary>
            /// This property gets or sets the value for 'PromptTextBox'.
            /// </summary>
            public TextBoxComponent PromptTextBox
            {
                get { return promptTextBox; }
                set { promptTextBox = value; }
            }
            #endregion
            
        #endregion
        
    }
    #endregion

}












